/*************************************************************************
	> File Name: MyCacheThread.cpp
	> Author: Chao
	> Mail:1311159643@qq.com 
	> Created Time: Tue 07 Apr 2015 05:40:17 PM CST
 ************************************************************************/

#include "MyCacheThread.h"
#include "ThreadPoool.h"
#include "MyThread.h"
#include "MyCache.h"
#include<unistd.h>
#include<fstream>

void MyCacheThread::run()
{
  while(true)
  {
  sleep(60);
  scan_cache();
  std::cout << "scan cache " << std::endl;
  }
}

void MyCacheThread::get_related(ThreadPool* p)
{
m_p = p;
std::vector<MyThread>::iterator iter1 = (m_p ->m_threads).begin();
std::vector<MyThread*>::iterator iter2 = m_pthreads.begin();
   while(iter2 != m_pthreads.end() && iter1 != (m_p->m_threads).end())
   {
   *iter2 = &(*iter1);
   iter1 ++;
   iter2 ++;
   }

}
void MyCacheThread::scan_cache()
{
	std::vector<MyThread*>::iterator iter = m_pthreads.begin();
	for(; iter != m_pthreads.end(); iter++)
	{
	  ((*iter)->m_cache).read_from_file((m_p->m_conf).get_map()["my_cache"].c_str());
	  std::ofstream fout((m_p->m_conf).get_map()["my_cache"].c_str());
	  if(!fout)
	  {
	  throw std::runtime_error("scan cache :open cache failed");

	  }
	  ((*iter)->m_cache).write_to_file(fout);
	  fout.close();
	}
}

